name: Upload CS3 to GitHub Releases

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 256)'
        required: true
        default: '256'
      tag:
        description: 'Release tag (e.g., v256)'
        required: true
        default: 'v256'

jobs:
  upload-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download CS3 from source repo
      run: |
        echo "ğŸ“¥ Downloading MaxSeries.cs3..."
        curl -L -o MaxSeries.cs3 \
          "https://github.com/franciscoalro/TestPlugins/releases/download/${{ github.event.inputs.tag }}/MaxSeries.cs3" \
          || echo "âš ï¸  File not found in source repo, will check local"
        
        if [ -f "releases/MaxSeries.cs3" ]; then
          echo "âœ… Using local releases/MaxSeries.cs3"
          cp releases/MaxSeries.cs3 MaxSeries.cs3
        fi
        
        ls -la MaxSeries.cs3
        
    - name: Calculate file hash
      run: |
        echo "ğŸ” Calculating SHA256 hash..."
        sha256sum MaxSeries.cs3
        echo "File size: $(stat -c%s MaxSeries.cs3) bytes"
        
    - name: Create or update GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag }}
        name: MaxSeries ${{ github.event.inputs.tag }}
        body: |
          ## MaxSeries ${{ github.event.inputs.tag }} - PlayerEmbedAPI V8+V7 Fixes
          
          ### ğŸš€ Novidades
          - PlayerEmbedAPI V8 (Pure HTTP): 12 padrÃµes de URL
          - PlayerEmbedAPI V7 (WebView): Memory leak fix
          - Timeout global: 15s â†’ 25s
          - Max attempts: 3 â†’ 5
          
          ### ğŸ”§ CorreÃ§Ãµes
          - Regex JWPlayer mais robusto
          - Novos CDNs: Akamai, CloudFront, Fastly, BunnyCDN, CDN77
          - ValidaÃ§Ã£o de URL aprimorada
          - Flag atÃ´mica no WebView cleanup
          
          ### ğŸ“Š InformaÃ§Ãµes
          - VersÃ£o: ${{ github.event.inputs.version }}
          - Tamanho: ~638 KB
          - Extractors: 7 + fallback
          - Taxa de sucesso: ~99%
          
          **InstalaÃ§Ã£o:**
          1. Baixe o arquivo MaxSeries.cs3
          2. No CloudStream: ConfiguraÃ§Ãµes â†’ ExtensÃµes â†’ Instalar de arquivo .cs3
        draft: false
        prerelease: false
        files: |
          MaxSeries.cs3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify release
      run: |
        echo "âœ… Release ${{ github.event.inputs.tag }} created/updated"
        echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.tag }}"
